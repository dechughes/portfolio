// Enhanced album data
const albumData = {

  'voodoo': {
    title: "Voodoo",
    artist: "D'Angelo",
    year: "2000",
    description: "Voodoo was recorded during extended sessions at Electric Lady Studios and brought together elements of funk, soul, hip-hop and jazz, becoming a key album of the Soulquarians period.",
    tracks: [
      "Untitled (How Does It Feel)",
      "Devil's Pie",
      "Left & Right (feat. Method Man & Redman)",
      "Spanish Joint"
    ],
    credits: "Produced by D'Angelo & Questlove",
    sessionLocation: "Electric Lady Studios, NYC",
    soulquarians: ["Questlove", "J Dilla", "Pino Palladino", "James Poyser"],
    collaborators: ["Method Man", "Redman", "Roy Hargrove"],
    themes: ["Sensuality", "Spirituality", "Black identity", "Live musicianship", "Late-night soul"],
    whyItMatters: "Voodoo went on to influence a generation of neo-soul and helped reset expectations of what a modern soul album could sound and feel like.",
    connections: ['mamas-gun', 'things-fall-apart'],
    color: '#8B4513',
    colorDark: '#2F1B12',
    audioUrl: "covers/mp3/feellikemakinlove.mp3",
    streamingLinks: {
     spotify: "https://open.spotify.com/album/2lO9yuuIDgBpSJzxTh3ai8?si=cfxSIbfaQduhPZ1B3m9GAA",
     apple: "https://music.apple.com/us/album/voodoo/1440841365",
     amazon: "https://www.amazon.com/music/player/albums/B01MSZLWKM"
    }
  },

  'mamas-gun': {
    title: "Mama's Gun",
    artist: "Erykah Badu",
    year: "2000",
    description: "A raw, emotional and politically aware follow-up that leaned even deeper into the Soulquarians’ live-band, late-night studio energy. Intimate, funky and fiercely personal.",
    tracks: [
      "Bag Lady",
      "Didn't Cha Know",
      "Green Eyes",
      "Booty"
    ],
    credits: "Produced by Erykah Badu, J Dilla, James Poyser & Soulquarians",
    sessionLocation: "Electric Lady Studios, NYC",
    soulquarians: ["J Dilla", "Questlove", "James Poyser", "Pino Palladino"],
    collaborators: ["Roy Hargrove", "Stephen 'Thundercat' Bruner (later era influence)"],
    themes: ["Self-worth", "Spiritual growth", "Love & heartbreak", "Black womanhood", "Afrofuturism"],
    whyItMatters: "Mama’s Gun expanded neo-soul into deeply personal and political territory, cementing Badu as a spiritual and cultural voice of the movement.",
    connections: ['voodoo', 'things-fall-apart'],
    color: '#D4A574',
    colorDark: '#6B4A2F',
    audioUrl: "covers/mp3/didntchaknow.mp3",
    streamingLinks: {
     spotify: "https://open.spotify.com/album/4z7ma1ujO4FDL1l2YBGw7b?si=DOm1MCBDRT-47y0YgbKzMw",
     apple: "https://music.apple.com/us/album/mamas-gun/1440755899",
     amazon: "https://www.amazon.com/music/player/albums/B001NU0K3S"
    }
  },

  'things-fall-apart': {
    title: "Things Fall Apart",
    artist: "The Roots",
    year: "1999",
    description: "The Roots’ breakthrough album that bridged underground credibility with mainstream impact, built around Questlove’s signature swing and a live-band hip-hop aesthetic.",
    tracks: [
      "You Got Me (feat. Erykah Badu)",
      "The Next Movement",
      "The Spark",
      "Act Too (The Love of My Life)"
    ],
    credits: "Produced by The Roots",
    sessionLocation: "Electric Lady Studios & various NYC studios",
    soulquarians: ["Questlove", "Black Thought"],
    collaborators: ["Erykah Badu", "Jill Scott", "Dice Raw"],
    themes: ["Community", "Love", "Hip-hop tradition", "Black culture", "Live instrumentation"],
    whyItMatters: "This album helped bring the Soulquarians’ live, soulful approach into the hip-hop mainstream.",
    connections: ['voodoo', 'mamas-gun', 'like-water'],
    color: '#B22222',
    colorDark: '#4B0F0F',
    audioUrl: "covers/mp3/aintsayinnothinnew.mp3",
    streamingLinks: {
     spotify: "https://open.spotify.com/album/0qbl8aNaCUOvX8HGsZYLfh?si=HdT84pVvQU-VHjlZM46fOg",
     apple: "https://music.apple.com/us/album/things-fall-apart/1440632803",
     amazon: "https://www.amazon.com/Things-Fall-Apart-Explicit-Roots/dp/B002IV5BFS"
    }
  },

  'like-water': {
    title: "Like Water for Chocolate",
    artist: "Common",
    year: "2000",
    description: "Common’s creative rebirth, steeped in J Dilla’s warm, dusty production and the Soulquarians’ late-night studio chemistry. Political, soulful and deeply human.",
    tracks: [
      "The Light",
      "The 6th Sense",
      "Funky For You",
      "Geto Heaven Part Two (feat. D'Angelo)"
    ],
    credits: "Produced by J Dilla, Questlove, DJ Premier & Soulquarians",
    sessionLocation: "Electric Lady Studios, NYC",
    soulquarians: ["J Dilla", "Questlove", "James Poyser"],
    collaborators: ["D'Angelo", "Bilal", "Jill Scott"],
    themes: ["Black love", "Social justice", "Spirituality", "Chicago soul", "Conscious rap"],
    whyItMatters: "Often seen as the definitive Soulquarians hip-hop album, it fused political rap with the warmth of neo-soul.",
    connections: ['voodoo', 'things-fall-apart', 'donuts'],
    color: '#2A9D8F',
    colorDark: '#0F3D3A',
    audioUrl: "covers/mp3/thelight.mp3",
    streamingLinks: {
     spotify: "https://open.spotify.com/album/72GMOkq47rXzdAMJrjf4RV?si=ewM3f_6ER4ylWV0e-TJAVA",
     apple: "https://music.apple.com/us/album/like-water-for-chocolate/1854231673",
     amazon: "https://www.amazon.com/music/player/albums/B000WLYQLG"
    }
  },

  'black-on-both-sides': {
    title: "Black on Both Sides",
    artist: "Mos Def",
    year: "1999",
    description: "Mos Def’s debut solo album - a sharp, soulful and politically conscious statement blending boom bap, jazz, soul and spoken word. A spiritual cousin to the Soulquarians sound.",
    tracks: [
      "Ms. Fat Booty",
      "Umi Says",
      "Mathematics",
      "Hip Hop",
      "Love"
    ],
    credits: "Produced by Mos Def, DJ Premier, Diamond D, Ali Shaheed Muhammad, Ayatollah, Easy Mo Bee, Minnesota",
    sessionLocation: "Electric Lady Studios, Chung King Studios & Battery Studios, NYC",
    soulquarians: ["Questlove", "D'Angelo", "Common"],
    collaborators: ["Q-Tip", "Busta Rhymes", "Talib Kweli"],
    themes: ["Black consciousness", "Spoken word", "Hip-hop purism", "Love & politics", "NYC energy"],
    whyItMatters: "It helped define late-90s conscious rap and positioned Mos Def as one of hip-hop’s most important voices.",
    connections: ['voodoo', 'mamas-gun', 'things-fall-apart'],
    color: '#C2A878',
    colorDark: '#3A2E24',
    audioUrl: "covers/mp3/mathematics.mp3",
    streamingLinks: {
     spotify: "https://open.spotify.com/album/5gK2l2LgWY0BA4p9uy27z6?si=UKy4pnJwQF6oMDUUTn1g7g",
     apple: "https://music.apple.com/us/album/black-on-both-sides/1444213589",
     amazon: "https://www.amazon.co.uk/Black-Both-Sides-Explicit-Mos/dp/B008D18B2W"
    }
  }

};


// DOM elements
const records = Array.from(document.querySelectorAll('.record'));
const recordsContainer = document.querySelector('.records');
const crateContainer = document.querySelector('.crate-container');
const crateLayer = document.querySelector('.crate-layer');
const scene = document.getElementById('scene');
const detailLeft = document.getElementById('detailLeft');
const detailRight = document.getElementById('detailRight');
const audioPlayer = document.getElementById('audioPlayer');
const playBtn = document.getElementById('playBtn');
const interactionHint = document.querySelector('.interaction-hint');
const clickOverlay = document.querySelector('.click-overlay');
const heroAlbum = document.getElementById('heroAlbum');
const heroAlbumCover = document.getElementById('heroAlbumCover');

// State
let crateActivated = false;
let selectedIndex = -1;
let pulledOutRecord = null;
let isPlaying = false;
let isTransitioning = false;

// Initialize vinyl indicators
records.forEach((record) => {
  const vinylIndicator = document.createElement('div');
  vinylIndicator.className = 'vinyl-indicator';
  record.appendChild(vinylIndicator);
});

// ===== INITIAL STATE =====
updateHint('Click the records to begin');

// ===== CRATE ACTIVATION =====
crateContainer.addEventListener('click', (e) => {
  e.stopPropagation();
  
  if (!crateActivated) {
    activateCrate();
    return;
  }
  
  if (crateActivated && selectedIndex === -1) {
    selectRecord(0);
    return;
  }
  
  if (selectedIndex !== -1 && !pulledOutRecord) {
    pullOutRecord(records[selectedIndex]);
    return;
  }
});

function activateCrate() {
  crateActivated = true;
  crateContainer.classList.remove('inactive');
  crateContainer.classList.add('active');
  
  selectRecord(2);
  
  updateHint('Scroll or use arrows to browse • Click crate to pull out');
  
  setTimeout(() => {
    hideHint();
  }, 4000);
}

// ===== SCROLL TO SELECT =====
crateContainer.addEventListener('wheel', (e) => {
  e.preventDefault();
  
  if (!crateActivated || pulledOutRecord || isTransitioning) return;
  
  const delta = Math.sign(e.deltaY);
  
  if (delta > 0) {
    selectRecord(Math.min(selectedIndex + 1, records.length - 1));
  } else {
    selectRecord(Math.max(selectedIndex - 1, 0));
  }
  
  updateHint('Click crate to pull out');
}, { passive: false });

// ===== RECORD SELECTION =====
function selectRecord(index) {
  if (index < 0 || index >= records.length) return;
  if (selectedIndex === index) return;
  
  deselectAll();
  
  selectedIndex = index;
  const record = records[index];
  record.classList.add('selected');
  
  records.forEach((r, i) => {
    if (i !== index) {
      r.classList.add('dimmed');
    }
  });
  
  crateContainer.classList.add('has-selection');
}

function deselectAll() {
  selectedIndex = -1;
  records.forEach(r => {
    r.classList.remove('selected', 'dimmed');
  });
  crateContainer.classList.remove('has-selection');
}

// ===== PULL OUT RECORD =====
function pullOutRecord(record) {
  if (!record || isTransitioning) return;
  
  isTransitioning = true;
  
  const albumKey = record.dataset.album;
  
  console.log('Pulling out record:', albumKey);
  
  // Fade out crate
  crateContainer.classList.add('record-pulled-out');
  
  // Get the album cover image from the record
  const sleeve = record.querySelector('.sleeve');
  const backgroundImage = window.getComputedStyle(sleeve).backgroundImage;
  // Extract URL from url("...") format
  const imageUrl = backgroundImage.slice(5, -2);
  
  // Set hero album cover image
  heroAlbumCover.src = imageUrl;
  
  // Show hero album with animation
  setTimeout(() => {
    heroAlbum.classList.add('visible');
  }, 100);
  
  pulledOutRecord = record;
  
  // Show overlay
  clickOverlay.classList.add('active');
  
  // Show album details
  showAlbumDetails(albumKey, record);
  
  updateHint('Click anywhere to return');
  
  setTimeout(() => {
    isTransitioning = false;
  }, 700);
}

// ===== RETURN RECORD TO CRATE =====
function returnRecord() {
  if (!pulledOutRecord || isTransitioning) return;
  
  isTransitioning = true;
  
  const record = pulledOutRecord;
  
  // Hide hero album
  heroAlbum.classList.remove('visible', 'playing');
  
  setTimeout(() => {
    // Hide overlay
    clickOverlay.classList.remove('active');
    
    // Hide details
    hideDetails();
    
    // Stop audio
    stopAudio();
    
    // Restore crate
    crateContainer.classList.remove('record-pulled-out');
    
    // Deselect all
    deselectAll();
    
    updateHint('Scroll to browse • Click crate to pull out');
    
    setTimeout(() => {
      pulledOutRecord = null;
      isTransitioning = false;
      hideHint();
    }, 800);
  }, 50);
}

// ===== CLICK HANDLERS =====
clickOverlay.addEventListener('click', (e) => {
  e.stopPropagation();
  console.log('Overlay clicked');
  returnRecord();
});

scene.addEventListener('click', (e) => {
  console.log('Scene clicked', e.target);
  
  if (e.target === scene || e.target.classList.contains('scene')) {
    if (pulledOutRecord) {
      console.log('Returning record from scene click');
      returnRecord();
      return;
    }
    
    if (crateActivated && selectedIndex !== -1 && !pulledOutRecord) {
      console.log('Deselecting from scene click');
      deselectAll();
      updateHint('Scroll to browse • Click crate to pull out');
      setTimeout(() => hideHint(), 2000);
      return;
    }
  }
});

// ===== SHOW ALBUM DETAILS =====
function showAlbumDetails(albumKey, record) {
  const album = albumData[albumKey];
  if (!album) return;

  // ===== THEME COLOURS =====
  document.documentElement.style.setProperty('--album-color', album.color);
  document.documentElement.style.setProperty('--album-color-dark', album.colorDark);

  detailLeft.classList.add('themed');
  detailRight.classList.add('themed');

  // ===== BASIC INFO (LEFT) =====
  detailLeft.querySelector('.album-title').textContent = album.title;
  detailLeft.querySelector('.album-artist').textContent = album.artist;
  detailLeft.querySelector('.album-year').textContent = album.year;
  detailLeft.querySelector('.album-description').textContent = album.description;

  // ===== SESSION LOCATION (LEFT) =====
  let sessionLoc = detailLeft.querySelector('.session-location');
  if (!sessionLoc) {
    sessionLoc = document.createElement('div');
    sessionLoc.className = 'session-location';
    detailLeft.querySelector('.detail-content').insertBefore(
      sessionLoc,
      detailLeft.querySelector('.album-description')
    );
  }
  sessionLoc.textContent = album.sessionLocation;

  // ===== WHY IT MATTERS (LEFT) =====
  let why = detailLeft.querySelector('.why-it-matters');
  if (!why) {
    why = document.createElement('div');
    why.className = 'why-it-matters';
    detailLeft.querySelector('.detail-content').appendChild(why);
  }
  why.innerHTML = `
    <div class="why-title">Why it matters</div>
    <div class="why-text">${album.whyItMatters}</div>
  `;

// ===== SOULQUARIANS (LEFT) =====
  let soulq = detailLeft.querySelector('.connections');
  if (!soulq) {
    soulq = document.createElement('div');
    soulq.className = 'connections';
    soulq.innerHTML = `
      <div class="connections-title">Soulquarians on this album</div>
      <div class="connection-badges"></div>
    `;
    detailLeft.querySelector('.detail-content').appendChild(soulq);
  }
  const soulqBadges = soulq.querySelector('.connection-badges');
  soulqBadges.innerHTML = '';
  album.soulquarians.forEach(member => {
    const badge = document.createElement('span');
    badge.className = 'connection-badge';
    badge.textContent = member;
    soulqBadges.appendChild(badge);
  });
  
  // Add streaming links
  if (album.streamingLinks) {
    let streamingContainer = soulq.querySelector('.streaming-links');  // ← CHANGED: connections → soulq
    if (!streamingContainer) {
      streamingContainer = document.createElement('div');
      streamingContainer.className = 'streaming-links';
      soulq.appendChild(streamingContainer);  // ← CHANGED: connections → soulq
    }
    
    streamingContainer.innerHTML = '';
    
const platforms = [
  { 
    name: 'spotify', 
    icon: 'covers/icons/spotify.svg', 
    url: album.streamingLinks.spotify 
  },
  { 
    name: 'apple', 
    icon: 'covers/icons/apple-music.svg', 
    url: album.streamingLinks.apple 
  },
  { 
    name: 'amazon', 
    icon: 'covers/icons/amazon-music.svg', 
    url: album.streamingLinks.amazon 
  }
];

    
 platforms.forEach(platform => {
  if (platform.url) {
    const link = document.createElement('a');
    link.href = platform.url;
    link.target = '_blank';
    link.className = 'streaming-link';
    link.title = `Listen on ${platform.name.charAt(0).toUpperCase() + platform.name.slice(1)}`;
    
    // CREATE AN IMG ELEMENT INSTEAD
    const img = document.createElement('img');
    img.src = platform.icon;
    img.alt = platform.name;
    link.appendChild(img);
    
    streamingContainer.appendChild(link);
  }
    });
  }
  
  // ===== TRACK LIST (RIGHT) =====
  const trackList = detailRight.querySelector('.track-list');
  trackList.innerHTML = '';
  album.tracks.forEach(track => {
    const li = document.createElement('li');
    li.textContent = track;
    trackList.appendChild(li);
  });

  // ===== THEMES / MOOD (RIGHT) =====
  let themesBlock = detailRight.querySelector('.themes');
  if (!themesBlock) {
    themesBlock = document.createElement('div');
    themesBlock.className = 'themes';
    themesBlock.innerHTML = `
      <div class="themes-title">Themes & Mood</div>
      <div class="theme-badges"></div>
    `;
  }

  const themeBadges = themesBlock.querySelector('.theme-badges');
  themeBadges.innerHTML = '';
  album.themes.forEach(theme => {
    const badge = document.createElement('span');
    badge.className = 'theme-badge';
    badge.textContent = theme;
    themeBadges.appendChild(badge);
  });

  // ===== COLLABORATORS (RIGHT) =====
  let collabs = detailRight.querySelector('.collaborators');
  if (!collabs) {
    collabs = document.createElement('div');
    collabs.className = 'collaborators';
    collabs.innerHTML = `
      <div class="collaborators-title">Standout collaborators</div>
      <div class="collaborator-list"></div>
    `;
  }

  const collabList = collabs.querySelector('.collaborator-list');
  collabList.innerHTML = '';
  album.collaborators.forEach(name => {
    const span = document.createElement('span');
    span.className = 'collaborator-name';
    span.textContent = name;
    collabList.appendChild(span);
  });

  // ===== INSERT THEMES & COLLABS AFTER TRACKS (ORDER FIX) =====
  trackList.after(collabs);
  trackList.after(themesBlock);

  // ===== CREDITS (RIGHT) =====
  detailRight.querySelector('.album-credits').textContent = album.credits;

  // ===== AUDIO =====
  audioPlayer.src = album.audioUrl;

  // ===== ANIMATE IN =====
  setTimeout(() => {
    detailLeft.classList.add('visible');
    detailRight.classList.add('visible');
  }, 400);
}

function hideDetails() {
  detailLeft.classList.remove('visible', 'themed');
  detailRight.classList.remove('visible', 'themed');
}

// ===== AUDIO CONTROLS =====
playBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  console.log('Play button clicked');
  
  if (isPlaying) {
    audioPlayer.pause();
    isPlaying = false;
    playBtn.classList.remove('playing');
    heroAlbum.classList.remove('playing');
    playBtn.querySelector('.play-text').textContent = 'Play Top Track';
    playBtn.querySelector('.play-icon').textContent = '▶';
  } else {
    audioPlayer.play();
    isPlaying = true;
    playBtn.classList.add('playing');
    heroAlbum.classList.add('playing');
    playBtn.querySelector('.play-text').textContent = 'Pause';
    playBtn.querySelector('.play-icon').textContent = '❚❚';
  }
});

function stopAudio() {
  audioPlayer.pause();
  audioPlayer.currentTime = 0;
  isPlaying = false;
  playBtn.classList.remove('playing');
  heroAlbum.classList.remove('playing');
  playBtn.querySelector('.play-text').textContent = 'Play Top Track';
  playBtn.querySelector('.play-icon').textContent = '▶';
}

audioPlayer.addEventListener('ended', () => {
  isPlaying = false;
  playBtn.classList.remove('playing');
  heroAlbum.classList.remove('playing');
  playBtn.querySelector('.play-text').textContent = 'Play Top Track';
  playBtn.querySelector('.play-icon').textContent = '▶';
});

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', (e) => {
  console.log('Key pressed:', e.key);
  
  if (e.key === 'Escape') {
    console.log('ESC pressed, pulledOutRecord:', pulledOutRecord);
    if (pulledOutRecord) {
      returnRecord();
    } else if (crateActivated && selectedIndex !== -1) {
      deselectAll();
      updateHint('Scroll to browse • Click crate to pull out');
    }
  }
  
  if (e.key === ' ' && pulledOutRecord) {
    e.preventDefault();
    playBtn.click();
  }
  
  if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && crateActivated && !pulledOutRecord) {
    e.preventDefault();
    
    if (!crateActivated) {
      activateCrate();
      return;
    }
    
    if (e.key === 'ArrowDown') {
      selectRecord(Math.min(selectedIndex + 1, records.length - 1));
    } else {
      selectRecord(Math.max(selectedIndex - 1, 0));
    }
    
    updateHint('Click crate to pull out');
  }
  
  if (e.key === 'Enter') {
    e.preventDefault();
    
    if (!crateActivated) {
      activateCrate();
    } else if (selectedIndex !== -1 && !pulledOutRecord) {
      pullOutRecord(records[selectedIndex]);
    }
  }
});

// ===== INFO PANEL =====
const infoButton = document.getElementById('infoButton');
const infoPanel = document.getElementById('infoPanel');
const infoClose = document.getElementById('infoClose');

// Open info panel
infoButton.addEventListener('click', (e) => {
  e.stopPropagation();
  infoPanel.classList.add('visible');
  console.log('Info panel opened');
});

// Close info panel
infoClose.addEventListener('click', (e) => {
  e.stopPropagation();
  infoPanel.classList.remove('visible');
  console.log('Info panel closed');
});

// Close info panel when clicking outside
document.addEventListener('click', (e) => {
  if (infoPanel.classList.contains('visible') && 
      !infoPanel.contains(e.target) && 
      !infoButton.contains(e.target)) {
    infoPanel.classList.remove('visible');
  }
});

// ESC key also closes info panel
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && infoPanel.classList.contains('visible')) {
    infoPanel.classList.remove('visible');
  }
});


// ===== INTERACTION HINTS =====
function updateHint(text) {
  if (interactionHint) {
    interactionHint.textContent = text;
    interactionHint.classList.remove('hide');
    interactionHint.classList.add('show');
  }
}

function hideHint() {
  if (interactionHint) {
    interactionHint.classList.remove('show');
    interactionHint.classList.add('hide');
  }
}

// ===== INITIAL SETUP =====
crateContainer.classList.add('inactive');

console.log('Script loaded. Elements:', {
  scene,
  clickOverlay,
  crateContainer,
  records: records.length
});